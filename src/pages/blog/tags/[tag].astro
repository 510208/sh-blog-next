---
import { getCollection } from "astro:content";
import { sortByDate } from "../../../lib/sortByDate";
import BaseLayout from "@/components/layouts/BaseLayout.astro";
import { SITE_TITLE } from "@/consts";
import config from "@shConfig";
import Hero from "@/components/content/Home/Hero.astro";
import { HeroTitle, HeroSubtitle } from "@/components/content/Home/HeroItems";
import BaseMainContent from "@/components/layouts/BaseMainContent.astro";
import Sidebar from "@/components/Sidebar.astro";
import { Hash } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import TimelineSinglePost from "@/components/ui/timeline/TimelineSinglePost.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => {
    // 開發環境顯示所有文章,生產環境過濾掉 draft 文章
    if (import.meta.env.DEV) return true;
    return data.draft !== true;
  });

  // 取得所有不重複的標籤
  const tags = [
    ...new Set(posts.map((post: any) => post.data.tags).flat()),
  ].filter((d: any) => !!d);

  // 使用 Map 去重 slug,避免重複參數
  const tagsMap = new Map();
  tags.forEach((t: any) => {
    const slug = t.toLowerCase().replace(/\s+/g, "-");
    if (slug && !tagsMap.has(slug)) {
      tagsMap.set(slug, t);
    }
  });

  // 建立每個標籤的路徑
  const tagsList = Array.from(tagsMap.entries()).map(([slug, t]) => {
    return {
      params: { tag: slug },
      props: {
        tag: t,
        posts: sortByDate(
          posts.filter((p) => {
            return p.data.tags
              ?.map((tag: any) => tag.toLowerCase())
              .includes(t.toLowerCase());
          }),
        ),
      },
    };
  });

  return tagsList;
}

const { posts, tag } = Astro.props as any;

// 按年份分組文章
const postsByYear = posts.reduce((acc: any, post: any) => {
  const year = new Date(post.data.pubDate).getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {});

const years = Object.keys(postsByYear).sort(
  (a, b) => parseInt(b) - parseInt(a),
);
---

<BaseLayout
  title={`標籤 ${tag} ${config.style.titleSeparator} ${SITE_TITLE}`}
  description={`標籤為 ${tag} 的文章列表`}
>
  <!-- Hero Section -->
  <Hero>
    <div class="lg:col-span-2" slot="left">
      <HeroTitle>{tag}</HeroTitle>
      <HeroSubtitle slot="right">
        以下是標籤為 {tag} 的所有文章列表。
      </HeroSubtitle>
    </div>
  </Hero>

  <BaseMainContent>
    <div class="flex-1">
      <div class="space-y-8">
        {
          years.map((year) => {
            const yearPosts = postsByYear[year];
            return (
              <div class="relative">
                {/* 年份標題 */}
                <div class="flex items-center gap-4 mb-6">
                  <h2 class="text-4xl font-bold text-gray-900 dark:text-white">
                    {year}
                  </h2>
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-green-500" />
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                      {yearPosts.length} 篇文章
                    </span>
                  </div>
                </div>

                {/* 時間線 */}
                <div class="relative pl-8 border-l-2 border-gray-200 dark:border-gray-700">
                  {yearPosts.map((post: any, index: number) => {
                    const month = new Date(post.data.pubDate)
                      .toLocaleDateString("zh-TW", {
                        month: "2-digit",
                        day: "2-digit",
                      })
                      .replace("/", "-");
                    const postTags = post.data.tags || [];

                    return (
                      <div class="relative mb-8 group">
                        {/* 時間線圓點 */}
                        <div class="absolute -left-9.75 top-1 w-3 h-3 rounded-full bg-gray-400 dark:bg-gray-600 group-hover:bg-green-500 transition-colors" />

                        {/* 日期標籤 */}
                        <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                          {month}
                        </div>

                        {/* 文章卡片 */}
                        <TimelineSinglePost
                          postData={post}
                          postTags={postTags}
                        />
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })
        }
      </div>
    </div>

    <Sidebar />
  </BaseMainContent>
</BaseLayout>
