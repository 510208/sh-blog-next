---
import Giscus from "@giscus/react";

import config from "@shConfig";
import { Skeleton } from "@ui/skeleton";
import { Separator } from "@ui/separator";

const GISCUS_ENABLED = config.behavior.commentConfig.enableComment === "Giscus";
const GISCUS_CONFIG = config.behavior.commentConfig.giscusConfig;
const UTTERANCES_ENABLED =
  config.behavior.commentConfig.enableComment === "Utterances";
const UTTERANCES_CONFIG = config.behavior.commentConfig.utterancesConfig;
const COMMENT_DISABLED = config.behavior.commentConfig.enableComment === "None";

// 開發階段檢查 Utterances repo 是否存在
let UTTERANCES_REPO_EXISTS = true;
if (import.meta.env.DEV && UTTERANCES_ENABLED) {
  const repo = UTTERANCES_CONFIG.repo;
  try {
    const response = await fetch(`https://api.github.com/repos/${repo}`, {
      headers: {
        'Accept': 'application/vnd.github+json',
      },
    });
    if (!response.ok) {
      console.warn(
        `⚠️ Utterances 設定警告: GitHub repo "${repo}" 不存在或無法存取 (狀態碼: ${response.status})`,
      );
      UTTERANCES_REPO_EXISTS = false;
    }
  } catch (error) {
    console.warn(
      `⚠️ Utterances 設定警告: 無法驗證 GitHub repo "${repo}"`,
      error,
    );
  }
}
---

{ !COMMENT_DISABLED && (<div id="comment-sep" class="my-10"><Separator client:load /></div>) }

{
  GISCUS_ENABLED && (
    <Giscus
      id="comments"
      repo={GISCUS_CONFIG.repo}
      repoId={GISCUS_CONFIG.repoId}
      category={GISCUS_CONFIG.category}
      categoryId={GISCUS_CONFIG.categoryId}
      mapping={GISCUS_CONFIG.mapping}
      strict={GISCUS_CONFIG.strict}
      reactionsEnabled={GISCUS_CONFIG.reactionsEnabled}
      emitMetadata={GISCUS_CONFIG.emitMetadata}
      inputPosition={GISCUS_CONFIG.inputPosition}
      theme={GISCUS_CONFIG.theme}
      lang={GISCUS_CONFIG.lang}
      loading="lazy"
      client:only="react"
    >
      <div slot="fallback">
        <Skeleton />
      </div>
    </Giscus>
  )
}

{
  UTTERANCES_ENABLED && UTTERANCES_REPO_EXISTS && (
    <div id="comments" />

    <style>
      .utterances {
        max-width: none;
      }
    </style>

    <script define:vars={{ UTTERANCES_CONFIG }}>
      const script = document.createElement("script");

      script.type = "text/javascript";
      script.src = "https://utteranc.es/client.js";

      script.setAttribute("repo", UTTERANCES_CONFIG.repo);
      script.setAttribute("issue-term", UTTERANCES_CONFIG.issueTerm);
      script.setAttribute("label", UTTERANCES_CONFIG.label);
      script.setAttribute("theme", UTTERANCES_CONFIG.theme);
      script.setAttribute("crossorigin", "anonymous");

      script.async = true;

      document.querySelector("#comments")?.appendChild(script);
    </script>
  ) || ( <p class="text-red-600"><strong>警告！</strong> Utterances 的 GitHub repo 不存在或無法存取。</p> )
}
