---
import { Button } from "./ui/button";
import { CardTitle } from "./ui/card";
import { ChevronDown } from "lucide-react";

interface Props {
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
}

const { headings } = Astro.props;

// 清理文本：移除錨點符號
const cleanHeadingText = (text: string): string => {
  return text.replace("#", "").trim();
};

import config from "@shConfig";

// 構建樹形結構，根據 config 設定最小與最大深度
const minDepth = config.behavior.tableOfContents.minDepth;
const maxDepth = config.behavior.tableOfContents.maxDepth;

const tocTree = headings.reduce(
  (acc, heading) => {
    if (heading.depth === minDepth) {
      acc.push({
        ...heading,
        text: cleanHeadingText(heading.text),
        children: [],
      });
    } else if (
      heading.depth > minDepth &&
      (maxDepth === -1 || heading.depth <= maxDepth) &&
      acc.length > 0
    ) {
      acc[acc.length - 1].children.push({
        ...heading,
        text: cleanHeadingText(heading.text),
      });
    }
    return acc;
  },
  [] as Array<{
    depth: number;
    slug: string;
    text: string;
    children: Array<{ depth: number; slug: string; text: string }>;
  }>,
);
---

<div id="toc" class="sticky top-30 z-40 mt-5">
  {
    tocTree.length > 0 && (
      <div class="flex flex-col h-full">
        <div class="px-4 py-3 border-b border-slate-700">
          <CardTitle className="text-white text-sm font-semibold tracking-wider bg-transparent">
            文章目錄
          </CardTitle>
        </div>
        <nav class="flex-1 overflow-y-auto" data-blog-toc-nav>
          <ol class="py-2" data-blog-toc>
            {tocTree.map((item, index) => (
              <li class="group">
                <a
                  href={`#${item.slug}`}
                  class={`toc-link toc-level-${minDepth} flex items-center gap-2 px-4 py-2 text-sm text-slate-300 hover:text-white transition-colors duration-400 relative`}
                  data-heading-index={index}
                  data-heading-slug={item.slug}
                >
                  <span class="flex-1 truncate">{item.text}</span>
                  {item.children.length > 0 && (
                    <Button
                      className="toc-toggle shrink-0 w-5 h-5 flex items-center justify-center rounded hover:bg-slate-700 transition-colors"
                      data-toggle-target={`toc-children-${index}`}
                      type="button"
                      aria-label={`展開 ${item.text} 的子項`}
                      aria-expanded="false"
                      aria-controls={`toc-children-${index}`}
                      asChild
                    >
                      <ChevronDown
                        size={16}
                        className="transition-transform duration-400"
                      />
                    </Button>
                  )}
                </a>
                {item.children.length > 0 && (
                  <ul
                    class="toc-children overflow-hidden transition-all duration-400"
                    id={`toc-children-${index}`}
                    style="max-height: 0;"
                    hidden
                  >
                    {item.children.map((child) => (
                      <li>
                        <a
                          href={`#${child.slug}`}
                          class={`toc-link toc-level-${child.depth} block py-1.5 text-xs text-slate-400 hover:text-slate-100 transition-colors duration-400 truncate`}
                          style={`padding-left: ${1.5 + (child.depth - minDepth) * 1}rem;`}
                          data-heading-slug={child.slug}
                          tabindex="-1"
                        >
                          {child.text}
                        </a>
                      </li>
                    ))}
                  </ul>
                )}
              </li>
            ))}
          </ol>
        </nav>
      </div>
    )
  }
</div>

<script define:vars={{ minDepth }}>
  let currentH2Index = null;

  // 設置標題的滾動邊距，防止被 TOC 卡住
  document
    .querySelectorAll("article :is(h2,h3,h4,h5,h6)")
    .forEach((heading) => {
      heading.style.scrollMarginTop = "90px";
    });

  // 切換子項顯示/隱藏
  document.querySelectorAll(".toc-toggle").forEach((button) => {
    button.addEventListener("click", (e) => {
      e.preventDefault();
      const targetId = button.getAttribute("data-toggle-target");
      if (!targetId) return;
      const target = document.getElementById(targetId);
      if (!target) return;

      const isHidden = target.hasAttribute("hidden");

      if (isHidden) {
        // 展開：先移除 hidden，觸發 reflow 後再設置 max-height
        target.removeAttribute("hidden");
        target.querySelectorAll("a").forEach((link) => {
          link.removeAttribute("tabindex");
        });
        // 強制 reflow 讓 display 變化生效
        void target.offsetHeight;
        target.style.maxHeight = "1000px";
        button.setAttribute("aria-expanded", "true");
      } else {
        // 收合：先設置 max-height 觸發動畫，結束後再設置 hidden
        target.style.maxHeight = "0px";
        button.setAttribute("aria-expanded", "false");
        setTimeout(() => {
          target.setAttribute("hidden", "");
          target.querySelectorAll("a").forEach((link) => {
            link.setAttribute("tabindex", "-1");
          });
        }, 400);
      }

      // 旋轉箭頭
      const chevron = button.querySelector("svg");
      if (chevron) {
        chevron.style.transform = isHidden ? "rotate(-180deg)" : "rotate(0deg)";
      }
    });
  });

  // 當用戶點擊某個標題時，自動展開其父項
  document
    .querySelectorAll("article :is(h2,h3,h4,h5,h6)")
    .forEach((heading) => {
      heading.addEventListener("click", () => {
        const slug = heading.id;
        const tocLink = document.querySelector(
          `[data-blog-toc] a[data-heading-slug="${slug}"]`,
        );

        if (tocLink) {
          const parent = tocLink.closest("li");
          if (parent) {
            const toggleButton =
              parent.previousElementSibling?.querySelector(".toc-toggle");
            if (toggleButton) {
              const targetId = toggleButton.getAttribute("data-toggle-target");
              if (targetId) {
                const target = document.getElementById(targetId);
                if (target && target.hasAttribute("hidden")) {
                  target.removeAttribute("hidden");
                  target.querySelectorAll("a").forEach((link) => {
                    link.removeAttribute("tabindex");
                  });
                  void target.offsetHeight;
                  target.style.maxHeight = "1000px";
                  toggleButton.setAttribute("aria-expanded", "true");
                  const chevron = toggleButton.querySelector("svg");
                  if (chevron) chevron.style.transform = "rotate(-180deg)";
                }
              }
            }
          }
        }
      });
    });

  // 高亮當前閱讀位置並自動展開/關閉父項
  const setCurrent = (entries) => {
    for (const entry of entries) {
      if (!entry.isIntersecting) continue;

      const id = entry.target.id;
      if (!id) continue;

      const tocLink = document.querySelector(
        `[data-blog-toc] a[data-heading-slug="${id}"]`,
      );
      if (!tocLink) continue;

      // 高亮
      document
        .querySelectorAll("[data-blog-toc] a.active")
        .forEach((e) => e.classList.remove("active"));
      tocLink.classList.add("active");

      const isRootHeading = tocLink.classList.contains(`toc-level-${minDepth}`);
      if (!isRootHeading) return;

      const index = tocLink.getAttribute("data-heading-index");
      if (!index) return;

      // 收起上一個 H2
      if (currentH2Index && currentH2Index !== index) {
        const prevChildren = document.getElementById(
          `toc-children-${currentH2Index}`,
        );
        if (prevChildren && !prevChildren.hasAttribute("hidden")) {
          prevChildren.style.maxHeight = "0px";
          const prevToggle = document.querySelector(
            `[data-toggle-target="toc-children-${currentH2Index}"]`,
          );
          if (prevToggle) {
            prevToggle.setAttribute("aria-expanded", "false");
          }
          setTimeout(() => {
            prevChildren.setAttribute("hidden", "");
            prevChildren.querySelectorAll("a").forEach((link) => {
              link.setAttribute("tabindex", "-1");
            });
          }, 400);
          const chevron = prevToggle?.querySelector("svg");
          if (chevron) chevron.style.transform = "rotate(0deg)";
        }
      }

      // 展開目前 H2
      const currentChildren = document.getElementById(`toc-children-${index}`);
      if (currentChildren && currentChildren.hasAttribute("hidden")) {
        currentChildren.removeAttribute("hidden");
        currentChildren.querySelectorAll("a").forEach((link) => {
          link.removeAttribute("tabindex");
        });
        void currentChildren.offsetHeight;
        currentChildren.style.maxHeight = "1000px";
        const toggle = document.querySelector(
          `[data-toggle-target="toc-children-${index}"]`,
        );
        if (toggle) {
          toggle.setAttribute("aria-expanded", "true");
        }
        const chevron = toggle?.querySelector("svg");
        if (chevron) chevron.style.transform = "rotate(-180deg)";
      }

      currentH2Index = index;
    }
  };

  const observerOption = {
    root: null,
    rootMargin: "0px 0px -50%",
    threshold: 0,
  };

  const headingObserver = new IntersectionObserver(setCurrent, observerOption);
  document
    .querySelectorAll("article :is(h2,h3,h4,h5,h6)")
    .forEach((heading) => headingObserver.observe(heading));
</script>
